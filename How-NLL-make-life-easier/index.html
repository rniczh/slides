<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>How NLL make life easier</title>
    <meta name="description" content="Some description about the slides">
    <meta name="author" content="You">
    <link rel="stylesheet" href="css/main.css">
  </head>
  <body>
    <textarea id="source">class: center, middle


.title[How NLL make life easier]
<br/>
<br/>
<br/>
<br/>
.center[<img src="img/rustq.png" width="35%">]
<br/>
<br/>
.author[Rnic / H.-S Zheng]
<br/>
<br/>
<br/>
.date[April 17, 2019]
<br/>

---
# About Me

<br/>
<br/>

Rnic / 鄭弘昇

‣ Telegram: [{ t.me/@rnicinr }](https://t.me/@rnicinr)

‣ <span style="color:#a64dff">**Emacs**</span> 教派的信徒

---
# Outline

* .highlight[**Lifetimes Concept**]

    * What is Lifetimes ?

    * Subtyping

* .highlight[**NLL**]

    * Phases of Borrow checker

    * Solving constraints

    * Limits and Alias-based formulation

---
class: center, middle

# Lifetimes Concept

.center[<img src="img/error.png" width="100%" alt="https://doc.rust-lang.org/book/ch10-03-lifetime-syntax.html">]

---

# .center[Borrow]

.center[<img src="img/rust-borrow.png" width="70%">]

.footnote[(by. https://rufflewind.com/img/rust-move-copy-borrow.png)]

--

<br/>

.center[**How long does it borrow ?**]

--

.center[.highlight[**NLL:] What is can borrowed here ?**]

---

# .center[Borrow]

A .pink[borrow] will generate a .pink[reference], and a reference will tagged with a .pink[lifetime]


### Borrow
--
 → Reference
--
 --- Lifetime

--

```rust
let r;
{
    let x = 5;
    r = &x;

}
println!("{}", r);
```

---

# .center[Borrow]


A .pink[borrow] will generate a .pink[reference], and a reference will tagged with a .pink[lifetime]


### Borrow → Reference --- Lifetime


```rust
let r;
{
    let x = 5;
    r = &'b x;     // -+-- 'b
                   //  |
*}                  // -+
println!("{}", r); //
```

--

<br/>
## .pink[.center[**Lifetime must smaller than Scope**]]

---

# .center[Lifetimes]

## .center[.highlight[Set of points on CFG]]

--

<br/>
.center[<img src="img/cfg.png" width="40%">]

---

# .center[Lifetimes]

.pull-left[

```rust
let mut foo: T = ...;
let mut bar: T = ...;
let p: &'p T;

p = &'foo foo;

if condition {

    print(*p);

    p = &'bar bar;
}

print(*p);
```

]

.pull-right[

```rust
A
[ p = &foo     ]
[ if condition ] ----\ (true)
       |             |
       |     B       v
       |     [ print(*p)     ]
       |     [ ...           ]
       |     [ p = &bar      ]
       |     [ ...           ]
       |     [ goto C        ]
       |             |
       +-------------/
       |
C      v
[ print(*p)    ]
[ return       ]

```

]

---


# .center[Lifetimes]

.pull-left[

```rust
let mut foo: T = ...;
let mut bar: T = ...;
let p: &'p T;

*p = &'foo foo;

if condition {

    print(*p);

    p = &'bar bar;
}

print(*p);
```

]

.pull-right[

```rust
A
[ p = &foo     ]
*[ if condition ] ----\ (true)
       |             |
       |     B       v
*      |     [ print(*p)     ]
       |     [ ...           ]
       |     [ p = &bar      ]
       |     [ ...           ]
       |     [ goto C        ]
       |             |
       +-------------/
       |
C      v
*[ print(*p)    ]
[ return       ]

```

```rust
'p:   { A/1, B/0, B/3, B/4, C/0 }

'foo: { A/1, B/0, C/0 }

'bar: { B/3, B/4, C/0 }
```

]

---

# .center[Lifetimes]

## Original Limits

```rust
 let mut s = "hello".to_string();

 let mut c = || s += " world"; // captured by &mut and c become FnMut

 c();

 println!("{}", s);

```

--

```
|     let mut c = || s += " world";
|                 -- - previous borrow occurs due to use of `s` in closure
|                 |
|                 mutable borrow occurs here
|     c();
|     println!("{}", s);
|                    ^ immutable borrow occurs here
| }
| - mutable borrow ends here
```

---

# .center[Lifetimes]

## How to solve it ?

```rust
 let mut s = "hello".to_string();

 let mut c = || s += " world"; ---+--- 'a
                                  |
 c();                             |
                                  |
 println!("{}", s);          -----+--- 'b
                                  |
                            ------+
```

--

```rust
 let mut s = "hello".to_string();
* {
     let mut c = || s += " world"; ---+--- 'a
                                      |
     c();                             |
* }                               ----+

 println!("{}", s);               ----+--- 'b

```

---

# .center[Subtyping]

.center[`'a : 'b` : lifetimes of `'a` is outlives `'b`]

--

```rust

  let p: &'p T;                            +--------+
                                           |        |
  p = &'foo foo;                'foo  +----+ Borrow +---->  'p
                                           |        |
                                           +--------+
```

---

# .center[Subtyping]

.center[`'a : 'b` : lifetimes of `'a` is outlives `'b`]

```rust

  let p: &'p T;                            +--------+
                                           |        |
  p = &'foo foo;                'foo  +----+    :   +---->  'p
                                           |        |
  ______________                           +--------+

   'foo : 'p

```

---

# .center[Variance]

.pull-left[

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:black;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:black;}
.tg .tg-60uc{font-size:16px;border-color:#000000;text-align:center;vertical-align:top}
.tg .tg-ltfh{font-size:16px;background-color:#9aff99;border-color:#000000;text-align:center;vertical-align:top}
</style>
<table class="tg">
  <tr>
    <th class="tg-60uc"></th>
    <th class="tg-60uc">'a</th>
    <th class="tg-60uc">T</th>
    <th class="tg-60uc">U</th>
  </tr>
  <tr>
    <td class="tg-60uc">&amp;'a T<br></td>
    <td class="tg-60uc">covariant</td>
    <td class="tg-60uc">covariant</td>
    <td class="tg-60uc"></td>
  </tr>
  <tr>
    <td class="tg-60uc">&amp;'a mut T </td>
    <td class="tg-60uc">covariant<br></td>
    <td class="tg-ltfh">invariant</td>
    <td class="tg-60uc"></td>
  </tr>
  <tr>
    <td class="tg-60uc">Box&lt;T&gt;</td>
    <td class="tg-60uc"></td>
    <td class="tg-60uc">covariant<br></td>
    <td class="tg-60uc"></td>
  </tr>
  <tr>
    <td class="tg-60uc">Vec&lt;T&gt;</td>
    <td class="tg-60uc"></td>
    <td class="tg-60uc">covariant<br></td>
    <td class="tg-60uc"></td>
  </tr>
  <tr>
    <td class="tg-60uc">UnsafeCell&lt;T&gt;</td>
    <td class="tg-60uc"></td>
    <td class="tg-ltfh">invariant</td>
    <td class="tg-60uc"></td>
  </tr>
  <tr>
    <td class="tg-60uc">Cell&lt;T&gt;</td>
    <td class="tg-60uc"></td>
    <td class="tg-ltfh">invariant</td>
    <td class="tg-60uc"></td>
  </tr>
  <tr>
    <td class="tg-60uc">fn(T) -&gt; U</td>
    <td class="tg-60uc"></td>
    <td class="tg-60uc">contravariant</td>
    <td class="tg-60uc">covariant</td>
  </tr>
  <tr>
    <td class="tg-60uc">*const T</td>
    <td class="tg-60uc"></td>
    <td class="tg-60uc">covariant<br></td>
    <td class="tg-60uc"></td>
  </tr>
  <tr>
    <td class="tg-60uc">*mut T</td>
    <td class="tg-60uc"></td>
    <td class="tg-ltfh">invariant</td>
    <td class="tg-60uc"></td>
  </tr>
</table>
]


.pull-right[



```
 +---+---+---+---+
 | X | 0 | + | - |
 +---------------+  0: invariant
 | 0 | 0 | 0 | 0 |  +: convariant
 +---------------+  -: contravariant
 | + | 0 | + | - |
 +---------------+
 | - | 0 | - | + |
 +---+---+---+---+



 +---+---+---+---+
 | ^ | 0 | + | - |
 +---------------+
 | 0 | 0 | 0 | 0 |
 +---------------+
 | + | 0 | + | 0 |
 +---------------+
 | - | 0 | 0 | - |
 +---+---+---+---+

```
]

.footnote[(by. https://medium.com/@kennytm/variance-in-rust-964134dd5b3e)]

---


## .center[Example]


```rust
let a = 1;
let p: Cell<&'p i32> = Cell::new(&'a a);

=> 'a: 'p, 'p: 'a

```


---


## .center[Example]


```rust
use std::marker::PhantomData;

pub struct Magic<'a>(PhantomData<&'a mut &'a ()>);

impl<'a> Magic<'a> {
    pub fn as_ref(&'a self) -> &'a Self {
        &self
    }
}

fn main() {
    let pin = Magic(PhantomData);
    {
        pin.as_ref();
    }
    pin;
}

```

.footnote[(ref. https://iovxw.net/p/phantomdata-magic/)]

---
class: center, middle

# NLL

.center[<img src="img/04_04-nll-02.png" width="80%" alt="https://hacks.mozilla.org/2018/12/rust-2018-is-here/">]

---

## .center[Example]

.footnote[[(play: link to play.rust-lang.org/ of this code with eidtion=2015)](https://play.rust-lang.org/?version=stable&mode=debug&edition=2015&gist=6deffeeb7145662d49b87dbe35dee1a1)]

```rust
 fn process_or_default(map: &mut HashMap<usize, String>,
                       key: usize)
 {
    match map.get_mut(&key) {
        Some(value) => {
            process(value);
            return;
        }
        None => {
            map.insert(key, V::default());
        }
    }
 }
```

---

## .center[Example]

.footnote[[(play: link to play.rust-lang.org/ of this code with eidtion=2015)](https://play.rust-lang.org/?version=stable&mode=debug&edition=2015&gist=6deffeeb7145662d49b87dbe35dee1a1)]

```rust
 fn process_or_default(map: &mut HashMap<usize, String>,
                       key: usize)
 {
    match map.get_mut(&key) {  --------------+-- 'a
        Some(value) => {                     |
            process(value);                  |
            return;                          |
        }                                    |
        None => {                            |
            map.insert(key, V::default()); ----- 'b
        }                                    |
    } <--------------------------------------+
 }
```


```
|     match map.get_mut(&key) {
|           --- first mutable borrow occurs here
...
|             map.insert(key, V::default());
|             ^^^ second mutable borrow occurs here
|         }
|     }
|     - first borrow ends here
```

---

## .center[Solution]

.footnote[[(play: link to play.rust-lang.org/ of this code with eidtion=2015)](https://play.rust-lang.org/?version=stable&mode=debug&edition=2015&gist=6deffeeb7145662d49b87dbe35dee1a1)]

```rust
 fn process_or_default(map: &mut HashMap<usize, String>,
                       key: usize)
 {
    match map.get_mut(&key) {
        Some(value) => {
            process(value);
            return;
        }
        None => {
*
        }
    }
*   map.insert(key, V::default());
}
```

--

<br/>

## .center[.pink[But it's annoying]]

---


# .center[Phases of Borrowck]

<br/>

### 1. Building liveness and constraints

### 2. Infer the lifetimes

### 3. Compute loans in scope

### 4. Check action and report errors

---


# .center[Location-aware subtyping]

.center[`('a : 'b) @ P` :

`'a` must include all points in `'b`

.pink[**that are reachable from**] location `P`
]


---

class: center, middle

# WIP

---

class: center, middle

# That's All.

    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js"></script>
    <script>window.remark || document.write(
  '<script src="js/vendor/remark.min.js"><\/script>'
)

    </script>
    <script src="js/vendor/remark-language.js"></script>
    <script src="js/main.js"></script>
  </body>
</html>